<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>房间总览</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="/static/lib/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/lib/css/homepage.css">
    <link rel="stylesheet" href="/static/lib/css/controller.css">
    <link rel="stylesheet" href="/static/lib/css/bootstrap-table.min.css">
    <link rel="stylesheet" type="text/css" href="/static/lib/css/sweetalert.css">
</head>
<body>
<div th:insert="~{../static/common/headbar::headbar}"></div>
<div th:insert="~{./detail_user::homepage}"></div>
<div class="panel panel-default" style="width: 90%;margin-left: 5%">
    <!--标题栏-->
    <div class="panel-heading">
        <h3 class="panel-title" style="text-align:center">租客总览</h3>
    </div>
    <!--工具栏-->
    <div id="toolbar" class="div-toolbar">
        <select name="select" id="memberStatus" class="form-condition">
            <option value="-1">全部</option>
            <option value="0">租住中</option>
            <option value="1">已退租</option>
        </select>
        <input name="memberSearch" id="memberSearch" class="form-condition" placeholder="租客姓名"/>
        <input name="roomSearch" id="roomSearch" class="form-condition" placeholder="房间号"/>
        <!--操作按钮-->
        <button id="search" class="btn btn-primary" th:onclick="|searchMember();|">搜 索</button>
        <button class="btn btn-success" th:onclick="|addMember()|">新 增
        </button>
        <button class="btn btn-info" th:onclick="|edit()|">编 辑</button>
        <button class="btn btn-danger" th:onclick="|deleteRows();|">删 除</button>
    </div>
    <!--表格-->
    <div class="panel-body">
        <table id="table" class="table-striped-warner">
        </table>
    </div>
</div>

<!-- （新增、修改） 模态框容器 -->
<div>
    <!-- 新增和修改共用一个模态框（Modal） -->
    <form id="addOrUpdateform" class="form-horizontal" role="form">
        <div class="modal fade" id="addOrUpdateModal" tabindex="-1" role="dialog" aria-labelledby="addOrUpdateModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            ×
                        </button>
                        <h4 class="modal-title" id="addOrUpdateModalLabel"/>
                    </div>
                    <!--                    {# 模态框body #}-->
                    <div class="modal-body" style="height: 100%;">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">租客名称</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" id="memberName" name="memberName" required
                                       placeholder="请输入租客名称">
                                <input type="hidden" class="form-control" id="memberId">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">手机号</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" id="tel" name="tel"
                                       required
                                       placeholder="请输入租客手机号">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">身份证号</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" id="idCard" name="idCard"
                                       placeholder="请输入租客身份证号">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">租住房间</label>
                            <div class="col-sm-7">
                                <select name="select" id="roomSelector" class="form-condition">
                                </select>
                            </div>
                        </div>

                    </div>
                    <!--                    {# 模态框底部 #}-->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <input type="button" onclick="addOrUpdate()" class="btn btn-primary" value="提交"/>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </form>
</div>
<script src="/static/lib/js/jquery.min.js"></script>
<script src="/static/lib/js/bootstrap.min.js"></script>
<script src="/static/lib/js/bootstrap-table.min.js"></script>
<script src="/static/lib/js/sweetalert-dev.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.16.0/locale/bootstrap-table-zh-CN.min.js"></script>

<!--页面功能script脚本-->
<script>
    /*表格初始化*/
    $('#table').bootstrapTable({
        url: '/member/data',
        method: 'post',
        pageNumber: 1,                  //初始化加载第一页，默认第一页
        uniqueId: "memberId",           // 表格唯一键
        pagination: true,               //是否显示分页（*）
        sidePagination: "server",       //分页方式：client客户端分页，server服务端分页（*）
        pageSize: 10,                       //每页的记录行数（*）
        pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
        contentType: 'application/json',
        toolbar: '#toolbar',
        showRefresh: true,   //是否显示刷新按钮
        showToggle: true,    //是否显示详细视图和列表视图的切换按钮
        showColumns: true,   //选择要显示的列
        striped: true,      //是否显示行间隔色
        toolbarAlign: 'left',//工具栏的位置
        clickToSelect: true,    //是否启用点击选中行
        cardView: false,     //是否显示详细视图
        detailView: true,   //是否显示父子表
        locale: 'zh-CN',
        queryParams: function (params) {    //传递参数（*）
            return {
                offset: params.offset,
                limit: params.limit,
                memberStatus: document.getElementById("memberStatus").value,
                memberName: $("#memberSearch").val(),
                roomNo: $("#roomSearch").val()
            }
        },
        responseHandler: function (res) {
            return {total: res.data.total, rows: res.data.rows}
        },
        columns: [{
            checkbox: true,
            visible: true
        }, {
            field: 'memberId',
            title: '租客ID',
            visible: false
        }, {
            field: 'roomId',
            title: '房间ID',
            visible: false
        }, {
            field: 'memberName',
            title: '租客姓名',
            align: "center", //表内容居中
        }, {
            field: 'roomNo',
            title: '房间号',
            align: "center", //表内容居中
            // visible: false
        }, {
            field: 'tel',
            title: '手机号',
            align: "center", //表内容居中
        }, {
            field: 'sex',
            title: '性别',
            align: "center", //表内容居中
        }, {
            field: 'idCard',
            title: '身份证',
            align: "center", //表内容居中
        }, {
            field: 'memberStatus',
            title: '租住状态',
            align: "center", //表内容居中
        }],
        cellStyle: function (value, row, index){return {css:{'background-color':'#F3F3F4'}};
        },
<!--        //自定义分页字符串显示为中文-->
<!--        formatShowingRows: function (pageFrom, pageTo, totalRows) {-->
<!--            return "第" + pageFrom + "到" + pageTo + "行，共" + totalRows + "条 ";-->
<!--        },-->
<!--        //自定义分页字符串显示为中文-->
<!--        formatRecordsPerPage: function (pageNumber) {-->
<!--            return "   " + pageNumber + ' 行每页';-->
<!--        },-->
        <!--展开子表-->
        onExpandRow: function (index, row, $detail) {
            $detail.html('<table></table>').find('table').bootstrapTable({
                url: '/lease',
                method: 'get',
                queryParams: {memberId: row.memberId},
                clickToSelect: true,
                responseHandler: function (res) {
                    return {rows: res.data}
                },
                columns: [{
                    field: 'leaseId',
                    title: '租约ID',
                    visible: false,
                }, {
                    field: 'leaseType',
                    title: '租约类型',
                    align: "center",
                }, {
                    field: 'unit',
                    title: '租约时长',
                    align: "center",
                }, {
                    field: 'rent',
                    title: '租金额',
                    formatter: amountFormatter,
                    align: "center",
                }, {
                    field: 'startDate',
                    title: '开始日期',
                    formatter: dateFormatter,
                    align: "center",
                }, {
                    field: 'endDate',
                    title: '结束日期',
                    formatter: dateFormatter,
                    align: "center",
                }]
            });
        }
    });
    $('td[data-rowcolor]').attr("style", "background-color:yellow;");
    /*添加租客*/
    function addMember() {
        initRoom();
        $('.modal-title').text("新增租客")
        $('#addOrUpdateModal').modal('show')
        $('#addOrUpdateform')[0].reset()  //重置表单
    }

    function edit() {
        initRoom();
        let selecton = $("#table").bootstrapTable('getSelections'); //获取该行数据
        if (selecton.length == 0) {
            swal("请选择需要修改的数据")
            return;
        } else if (selecton.length > 1) {
            swal("请选择单条数据修改")
            return;
        } else {
            let row = $("#table").bootstrapTable('getSelections')[0]; //获取该行数据
            if (row.id !== null) {
                // {# 修改modal框的标题 #}
                $('.modal-title').text('修改租客信息')
            }
            $('#addOrUpdateModal').modal('show')
            // 回填数据，记得回填隐藏的input框的value值为要修改的数据的id主键值
            $("#memberName").val(row.memberName);
            $("#memberId").val(row.id);
            $("#tel").val(row.tel);
            $("#idCard").val(row.idCard);
            $("#roomSelector").val(row.roomId);
        }
    };

     function amountFormatter(value) {
        return value + ' 元';
    }
    function dateFormatter(value, row) {
        return moment(value).format('YYYY-MM-DD');
    }

    function addOrUpdate() {
        let memberId = $('#memberId').val();
        console.log("memberId的值为：" + memberId)
        // {# 如果不存在project_id就是新增 #}
        if (!memberId) {
            $.ajax({
                type: "POST",
                url: "projects",
                dataType: "json",
                data: $('#addOrUpdateform').serialize(),
                success: function (res_data) {
                    console.log(res_data)
                    // {#关闭模态框并清除框内数据，否则下次打开还是上次的数据#}
                    $("#addOrUpdateform")[0].reset();
                    $('#addOrUpdateModal').modal('hide');
                    $("#mytab").bootstrapTable('refresh');
                }
            })
        }
        // {# 如果project_id存在就是修改 #}
        else {
            $.ajax({
                type: "PUT",
                dataType: "json",
                url: "room/roomNoList", // 待后端提供PUT修改接口
                // data: $('#addOrUpdateform').serialize(),

                success: function (data) {
                    console.log(data);
                    if (data.code == 200) {
                        toastr.success("修改成功");
                        $("#addOrUpdateform")[0].reset();
                        $('#project_id').val("")
                        $('#addOrUpdateModal').modal('hide');
                        $("#mytab").bootstrapTable('refresh');
                    } else {
                        toastr.warning('请填写所有数据');
                    }
                },
                error: function () {
                    toastr.warning("修改失败");
                }
            })
        }
    }


    function searchMember() {
        $("#table").bootstrapTable('refresh');
    }

    function deleteRows() {
        var rows = $("#table").bootstrapTable('getSelections');
        let length = rows.length;
        if (length === 0) {
            swal("请选择要删除的租客")
            return
        }
        swal({
                title: "确定删除吗？",
                text: "是否删除选中的"+ length +"条记录",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "确定删除",
                cancelButtonText: "取消删除",
                closeOnConfirm: false,
                // closeOnCancel: false
            },
            function(isConfirm){
                if (isConfirm) {
                    var arr = [];
                    $.each(rows, function (i, e) {
                        arr.push(e.memberId);
                    });
                    $.ajax("/member/deleteData", {
                        type: "get",
                        dataType: "json",
                        data: {
                            ids: arr
                        },
                        success: function (data) {
                            if (data.code == 200) {
                                swal("删除", "所选租客记录已删除",
                                    "success");
                                $("#table").bootstrapTable('refresh');
                            } else {
                                swal("删除失败", data.msg, "error")
                            }
                        },
                        error: function (data) {
                            swal("删除失败", data.responseJSON.msg, "error")
                        }
                    })

                }
            });
    }
    function initRoom(){
        $.ajax("/room/roomNoList", {
            type : 'get',
            dataType : "json",
            success : function(data) {
                var roomList = data.data;
                var opts = "";
                for( var index = 0; index < roomList.length; index++ ){
                    var room = roomList[index];
                    opts += "<option value='"+room.id+"'>"+room.number+'房'+"</option>";
                }
// 查询界面
                $("#roomSelector").append(opts);
                // $("#roomSelector").selectpicker("refresh");
            }
        });
    }
</script>
<script src="/static/lib/js/check.js"></script>
</body>
</html>